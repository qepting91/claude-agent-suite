# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a production-ready collection of 15 specialized AI agents, security configurations, and development tools for Claude Code. The project uses a **Jinja2-based template system** where source templates in `src/agents/` are compiled to production agents in `dist/agents/`, which are then distributed via installation scripts to users' `~/.claude/agents/` directory.

**Architecture**:
- **Development**: Contributors edit templates in `src/agents/*.md.j2`
- **Build**: `scripts/build.py` compiles templates to `dist/agents/*.md`
- **Distribution**: Installation scripts copy from `dist/agents/` to user systems
- **Legacy**: `agents/` directory contains old static files (being phased out)

## Key Commands

### Installation & Verification
```bash
# Linux/Mac installation
chmod +x install.sh
./install.sh

# Windows installation (PowerShell)
.\install.ps1

# Verify installation in Claude Code
/agents
/agents refresh

# Test diagnostics
/doctor
```

### Build System Commands
```bash
# Compile all templates
python scripts/build.py

# Build with detailed output
python scripts/build.py --verbose

# Validate templates without writing output
python scripts/build.py --validate-only

# Run test suite
pytest

# Run tests with coverage report
pytest --cov=scripts --cov-report=html

# Run build using Make (Linux/Mac)
make build
make test
```

### Development Workflow
```bash
# Edit template (not compiled output)
vim src/agents/agent-name.md.j2

# Build locally
python scripts/build.py --verbose

# Test compiled output
cp dist/agents/agent-name.md ~/.claude/agents/
# Then invoke it in Claude Code to test

# Run automated tests
pytest -v

# Commit only source files
git add src/agents/agent-name.md.j2
```

### Testing MCP Connections
```bash
# In Claude Code
/mcp
claude mcp list
```

## Architecture

### Build System Overview

The project uses a **template compilation pipeline**:

```
src/agents/*.md.j2  →  [Jinja2 + Validation]  →  dist/agents/*.md  →  ~/.claude/agents/
  (source)              (build system)            (output)            (user installation)
```

### Directory Structure

**Source Templates (`src/agents/`)**: Jinja2 templates with variables, includes, and control flow. These are the files contributors edit. Version controlled in git.

```jinja2
---
name: python-architect
description: >-
  Principal Python Systems Architect...
tools: Read, Glob, Grep, Edit, Bash
model: sonnet
---

{% include "skills/common/cognitive_protocol.md" %}

# Identity
You are a Principal Python Software Engineer...

{% include "skills/security/input_validation.md" %}
```

**Skills Library (`src/skills/`)**: Reusable components included via `{% include %}` directives. Enables DRY (Don't Repeat Yourself) principles:
- `common/cognitive_protocol.md`: Chain-of-thought reasoning framework
- `common/tool_usage_best_practices.md`: Tool usage guidelines
- `security/input_validation.md`: Input validation patterns

**Build Script (`scripts/build.py`)**: Python-based compiler using Jinja2:
- Discovers templates in `src/agents/*.md.j2`
- Renders templates with build context variables
- Validates output (frontmatter, token limits, bash syntax)
- Detects dangerous command patterns
- Writes compiled agents to `dist/agents/*.md`
- Reports statistics and errors

**Compiled Output (`dist/agents/`)**: Production-ready markdown files generated by build script. **Git-ignored** (not version controlled). This is what gets distributed to users.

**Legacy Directory (`agents/`)**: Old static files from pre-build-system era. Still present for backwards compatibility but will be removed. **Do not edit these files** - edit templates in `src/agents/` instead.

**Test Suite (`tests/`)**: Pytest-based tests covering:
- Unit tests for builder components
- Integration tests for complete workflows
- Bash syntax validation
- Dangerous command detection
- Template variable substitution

**Configuration (`config/`)**: Build system settings:
- `build_config.yml`: Source/output paths, validation rules, token limits
- `dangerous_commands.json`: Bash command pattern detection rules
- `settings.json`: User settings template (hooks, permissions)

**Agent Categories**:
- Backend (4): python-architect, go-expert, node-engineer, backend-engineer
- Frontend (3): frontend-architect, astro-expert, ux-ui-designer
- Database (3): postgres-dba, mysql-expert, mongo-architect (require MCP)
- Security (2): security-engineer, secure-code-reviewer
- Infrastructure (1): powershell-automator
- Application (1): streamlit-expert
- Meta (1): prompt-engineer

### Installation Flow

1. User clones repository → 2. Runs install script → 3. Script validates Claude Code is installed → 4. Creates timestamped backup of `~/.claude/` → 5. **Script runs build system** (`python scripts/build.py`) → 6. Copies `dist/agents/*.md` to `~/.claude/agents/` → 7. Copies docs to `~/.claude/` → 8. Merges settings.json (preserves existing config) → 9. User verifies with `/agents` command

### Security Design

**Least Privilege Principle**: Each agent only has access to tools it needs. Read-only agents (reviewers, analyzers) only get Read, Grep, Glob. Code modification agents add Edit cautiously. System agents requiring Bash need strong justification.

**Hook System**: PreToolUse hook validates bash commands for destructive operations, credential exposure, and unknown network requests before execution. Uses fast Haiku model with 15s timeout.

**Safe Distribution**: .gitignore prevents committing credentials, .env files, private keys, and connection strings with passwords. All examples use placeholders.

## Agent Design Philosophy

**Specificity Over Generality**: Each agent has focused expertise in one domain. No generic "helper" agents. Router uses the description field to accurately determine which agent to invoke.

**Actionable Instructions**: Agents contain clear, concrete steps and workflows. They include "when NOT to use" guidance to prevent router confusion.

**Tool Scoping**: Tools list follows principle of least privilege. Database agents get MCP access, reviewers get read-only tools, architects get Edit + Bash when justified.

**Cognitive Protocol**: Many agents (especially python-architect) follow chain-of-thought pattern: analyze context → formulate plan → safety check → implement.

## Build System Constraints

**Token Budget**: Maximum 2500 tokens per agent. Enforced during validation to prevent context window bloat. Estimated using word-based approximation (1.3 tokens per word average).

**Frontmatter Requirements**:
- `name`: Agent identifier (kebab-case)
- `description`: Router selection criteria (be specific)
- `tools`: Comma-separated tool list
- `model`: sonnet, haiku, or opus

**Template Extension**: Source files must use `.md.j2` extension. Output files use `.md` extension. This distinction makes it clear which files are source vs generated.

**File Locations**:
- ✅ **Commit**: `src/agents/*.md.j2`, `src/skills/**/*.md`
- ❌ **Never commit**: `dist/agents/*.md` (generated files, git-ignored)
- ❌ **Do not edit**: `agents/*.md` (legacy files, being phased out)

**Bash Validation**: All ```bash code blocks are checked for syntax errors using `bash -n`. On systems without bash (Windows), validation is skipped. Dangerous patterns are detected and warned.

**Dangerous Command Patterns**: Build system detects potentially destructive commands:
- Filesystem destruction: `rm -rf /`, `rm -rf *`
- Permission changes: `chmod -R 777`, `chown -R`
- System modifications: `mkfs`, `dd if=/dev/zero`
- Credential exposure: `export API_KEY=`, hardcoded passwords

**Jinja2 Syntax**: Unresolved template syntax ({{ or {%) in output indicates compilation failure. Build will fail if template variables are undefined or includes are missing.

## Common Patterns

### Agent File Structure
All agents follow consistent sections: Identity → Core Principles/Standards → Workflow → Best Practices → Tool Usage. This helps users understand agent capabilities and LLM internalize the role.

### Development Workflow

**For Template Development**:
1. Edit template: `src/agents/agent-name.md.j2`
2. Build: `python scripts/build.py --verbose`
3. Verify output: `cat dist/agents/agent-name.md`
4. Test locally: `cp dist/agents/agent-name.md ~/.claude/agents/`
5. Test in Claude Code: `/agent-name "test task"`
6. Run automated tests: `pytest -v`
7. Commit source only: `git add src/agents/agent-name.md.j2`

**For Skill Development**:
1. Create skill module: `src/skills/category/module.md`
2. Include in template: `{% include "skills/category/module.md" %}`
3. Build to test: `python scripts/build.py`
4. Verify inclusion: `grep "expected text" dist/agents/agent-name.md`

**Testing Checklist**:
1. Build succeeds without errors: `python scripts/build.py`
2. All tests pass: `pytest`
3. Verify behavior in Claude Code: `/agents`, `/agent-name "test"`
4. Tool restrictions enforced (no unexpected tool access)
5. Security review: no hardcoded secrets, minimal permissions, no injection vulnerabilities
6. Token count under 2500: Build validation checks this automatically

### Update Process
When repository updates: user runs `git pull` → re-runs install script → new backup created → **build system recompiles templates** → agents overwritten with latest compiled versions → settings.json preserved (only structure changes merged).

## Integration Points

**Trail of Bits Security Skills**: Repository includes integration guide for professional security skills marketplace. Essential skills: audit-context-building, differential-review, variant-analysis, fix-review.

**MCP Database Servers**: Database agents (postgres-dba, mysql-expert, mongo-architect) require MCP server configuration. Template provided for PostgreSQL, MySQL, and MongoDB connections. Users configure in `.mcp.json` (project-specific) or `~/.claude.json` (user-wide).

**Language Server Plugins**: Documentation recommends installing pyright-lsp, typescript-lsp, gopls-lsp for code intelligence. Not required but enhances agent capabilities.

## Important Constraints

**No Credential Commits**: Installation scripts, agent files, and documentation must never contain real credentials. Always use placeholders like `USERNAME:PASSWORD@localhost`.

**Settings Merge Logic**: Installation scripts detect existing `settings.json` and warn about manual merge requirement. Never overwrite user's existing hooks or permissions without consent.

**Cross-Platform Support**: Both install.sh (bash) and install.ps1 (PowerShell) must maintain feature parity. Color-coded output, error handling, and verification steps should match.

**Agent Naming Convention**: Use kebab-case, be specific (not generic), indicate role (architect/engineer/specialist/expert/reviewer). Template filename: `agent-name.md.j2`, compiled output: `agent-name.md`.

**Source Control Discipline**:
- Only commit source files in `src/` directory
- Never commit generated files from `dist/` directory
- .gitignore protects against accidental commits of dist/

**Build Required**:
- After editing templates in `src/agents/`, run `python scripts/build.py`
- Installation scripts automatically run build during setup
- CI/CD runs build on every commit to verify

**Testing Required**:
- Run `pytest` before committing template changes
- All tests must pass before merging pull requests
- CI/CD automatically runs tests on multiple platforms (Ubuntu, Windows, macOS) and Python versions (3.10-3.13)

## File Modification Guidelines

When modifying agents, preserve their structure and tool restrictions. When updating installation scripts, test on both platforms. When changing settings.json template, document what users need to merge manually.

Agent descriptions are critical - router uses them for selection. Make descriptions specific about technologies, patterns, and use cases. Avoid vague language like "helps with X" - instead use "specializes in Y when working with Z".
